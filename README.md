# cronwatch script

_under construction!_
_also see source code and help by running script without arguments_

## `croncrowd.sh`

### intro

If you run any kind of UNIX machine, you're probably familiar with
`crontab` and cronjobs. You may also use it to monitor the status of
your systems. But what if the cron daemon itself fails?
If you have more than one machine at your disposal for cronjobs, you
can let them monitor mutually, and this is where `croncrowd.sh` comes
into play. 

`croncrowd.sh` runs on each participating machine, publishes (on
some externally accessible and www-served directory) a short beacon
file, tries to get the corresponding beacon file from all other
machines, and checks whether their timestamps are not too distant
in the past.  Based on that, it can generate and send a report (if
all is fine) or a warning message to a receiving address, to alert
you or keep you informed.

### files

- `croncrowd.sh` is the script itself, which must be executable; it
  should work with `sh` or `bash` or `dash` or `ksh`
- a configuration file, readable by the script, by default at
  `$HOME/.croncrowd` located, and containing definitions or local
  parameters, and remote beacons
- temporary files, normally in `/tmp/` and called `croncrowd*.txt`,
  which must be readable and writable by the script

### usage

_(see also help provided by the script, if called without arguments)_

#### options

- `-d` for sending not more than one daily warning message for a
  continuously failing remote beacon. If you don't give this option,
  the script will send a warning at each run, if a beacon fails, which
  can be quite annoying, if you already received a warning.
- `-q` for suppressing the report when everything is ok.
- `-s` for adding some sensitive data to the beacon file. By default,
  only the timestamp for the script itself is added. With this option,
  also uptime, system time, hostname, and home directory are displayed.
  This may be useful if you want to remotely check on the load of the
  system, but it may give away sensitive data.

For normal operation, options `-d -q` are recommended.

#### config file

The name of the config file must be given to the script as argument.
It consists of lines with the following keywords:

##### `BEACON` mm url

mm is the maximum allowed age (in minutes) of the remote beacon.

If the remote beacon is older, it's cronjob facility may be
malfunctioning, which will result in a warning generated by the script.
This time span of course depends on the frequency of execution
of the remote `croncrowd.sh` script.
If mm is 0, this particular beacon will not be checked at all.

url is the location where the remote beacon file can be accessed.
Currently only HTTP is usable as protocol. The url should not contain
any whitespace.

`%bfn%` in url will be replace by the beacon file name (see `BFILE`)
as defined by the script.

You can add an URL for the local system as well, to verify
your local webserver is working correctly. In that case, you can
set a low number for mm, as the local beacon will be set by the script
immediately before the beacons are checked.

If an URL cannot be accessed (file not retrieved), this will also
treated as failure, generating a warning message from the script.

##### `WARN` addr

Address (or user name) which should receive warning messages by e-mail.
If undefined, `$USER` will be used instead.

If option `-d` is given, warnings for a beacon will be suppressed,
if there were already warnings sent out the same day.

##### `REPORT` addr

Address (or user name) which should receive report messages by e-mail.
If undefined, the argument to `WARN` will be used instead.

Report messages are sent at each run, unless suppressed with option `-q`
as discussed above.

##### `BDIR` path

Local writable publication path for own beacon.

This must be a directory, where the local beacon file can be written
for remote access by remote `croncrowd.sh` instances.

##### `BFILE` name

Name of beacon file, will replace `%bfn%` in remote beacon URLs.

_This is currently inactive, and the name is hardwired in the script._
_See script source code, if you want to set this active._

`cronbeacon.html` is the default name.

#### Notes

- You may use local shell variables like `$HOME` or `$USER` etc
  for the arguments to `WARN, REPORT, BDIR, BFILE.`
- All other keywords are ignored, therefore you can use '#' for comment lines.

#### Example

	warn    john@example.com
	# report unset, then same as warn
	# report        $USER+croncrowd
	bdir    $HOME/public_html
	# beacon list
	# %bfn% will be replaced by $bfn as defined in script
	beacon	9	http://localhost/%bfn%
	beacon	3600	http://www.example.org/%bfn%
	# ignore the following (max.age=0)
	beacon	0	http://www.nowhere.net/%bfn%

### Installation

1. create `.croncrowd` as discussed above
2. install cronjob for `croncrowd.sh -q -d $HOME/.croncrowd`
   (with options and config file location according to your preferences)


---

_(2017-Mar, YCB)_
